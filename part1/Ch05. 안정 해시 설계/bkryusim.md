# Ch05. 안정 해시 설계

### 다음 상황에서 예상되는 문제점과 해결 방안을 말해 주세요.

> 폭발적으로 성장 중인 SNS를 개발하는 기업에 취업했습니다. 사용자들의 포스트가 너무 많아 샤딩을 통해 분산 저장하려고 합니다. Auto Increment로 생성된 posts 테이블의 pk를 기준으로  모듈러 연산을 통해 샤딩을 구현하려고 합니다. 

* 샤딩의 기준을 사용자의 외래키인 `user_id`로 결정하는 경우, 어떤 장단점이 있을까요?
* 현 상황에서 적절한 시스템 설계를 제시해 주세요.

<details>
<summary><h4>해설</h4></summary>

> 다음 상황에서 예상되는 문제점과 해결 방안을 말해 주세요. SNS 서비스를 개발하려고 합니다. 사용자들의 포스트가 너무 많아 샤딩을 통해 분산 저장하려고 합니다. Auto Increment로 생성된 posts 테이블의 pk를 기준으로  모듈러 연산을 통해 샤딩을 구현하려고 합니다.
* 데이터가 폭발적으로 성장하고 있기 떄문에, 이후의 Rehashing까지 염두에 두어야 합니다. 모듈러 연산을 사용하는 경우 이후 rehashing 시 큰 부담으로 다가오게 됩니다. 안정 해시를 통해 해결할 수 있습니다.
* 또한 모듈러 연산의 기준을 post의 pk를 기준으로 하게 되면, 특정 한 유저의 포스트들이 여러 샤드에 퍼져 있기 떄문에, 이를를 모두 조회하는 기능을 구현하는데 어려움이 있을 수 있습니다. 상황에 맞게 외래키인 user_id를 기준으로 샤딩을 할 수도 있겠습니다.

> 샤딩의 기준을 사용자의 외래키인 `user_id`로 결정하는 경우, 어떤 장단점이 있을까요?
* 장점으로는 한 유저의 정보가 한 DB에 몰려 있기 때문에, 한 번의 요청에 대해 하나의 DB에서 모두 처리가 가능하고, JOIN이 가능해 조회 성능상 이점을 볼 수 있다는 장점이 있습니다.
* 단점으로는 유명인(Celebrity) 문제가 발생할 수 있습니다. 예를 들어 하나의 노드에 유명인의 계정 데이터가 모두 저장된다면, 하나의 노드에 데이터가 집중되고, 큰 트래픽이 몰리는 현상이 발생할 수 있습니다.

> 현 상황에서 적절한 시스템 설계를 제시해 주세요.
* user_id를 기준으로 해싱을 이용해 안정 해시를 사용합니다. 유명인 문제가 발생하는 노드는 조회 요청이 많이 발생할 가능성이 높기 때문에, 샤드별로 read 노드의 수를 다르게 설정해 성능을 높일 수 있을 것 같습니다.
* consistency가 크게 중요한 시스템이 아닌 것으로 판단되기 때문에, cassandra, dynamodb 등 안정 해시를 구현한 dbms를 이용하면 쉽게 구현할 수 있을 것 같습니다.
</details>


<br>

### 데이터를 분산 저장할 때 고려해야 할 사항으로는 어떤 것들이 있을까요?

* 리해싱이 쉽게 이루어지기 위한 안정 해시의 아이디어는 무엇인가요?
* 파티션별로 데이터 분포를 고르게 하기 위한 안정 해시의 아이디어는 무엇인가요?

<details>
<summary><h4>해설</h4></summary>

> 데이터를 분산 저장할 때 고려해야 할 사항으로는 어떤 것들이 있을까요?
* 리해싱이 쉽게 이루어져야 하고, 파티션별로 데이터의 분포가 골고루 이루어져야 합니다. 쓰기/읽기 트래픽이 골고루 이루어지도록 하는 것도 중요합니다.

> 리해싱이 쉽게 이루어지기 위한 안정 해시의 아이디어는 무엇인가요?
* 안정 해시는 해시 범위를 원형으로 매핑합니다. 해시 값을 구했을 때, 해시 치역 고리를 시계 방향으로 탐색하며 가장 빨리 만나는 노드에 값을 저장합니다. 만약 노드가 추가되거나 삭제되면, 해시 치역의 인접한 노드와 합의하면 쉽게 리해싱이 가능합니다.

> 파티션별로 데이터 분포를 고르게 하기 위한 안정 해시의 아이디어는 무엇인가요?
* 가상 노드를 사용해 실제 노드를 여러개의 가상 노드로 나누어 해시 링에 골고루 분포시킵니다. 가상 노드에 할당되는 데이터들은 가상 노드가 매핑하는 실제 노드에 데이터가 저장됩니다.
</details>
