# Ch12. 채팅 시스템 설계

### 서버는 메시지 수신 클라이언트에 메시지를 전송해줘야 한다. 어떤 방식을 사용할 수 있는가?

* 각 방식의 장, 단점은 무엇인가?
* 채팅 서버에 웹 소켓 프로토콜을 사용한다고 결정했다. 특정 채팅 서버에 부하가 몰리지 않도록 어떻게 관리할 수 있는가?

<details>
<summary><h4>해설</h4></summary>

> 서버는 메시지 수신 클라이언트에 메시지를 전송해줘야 한다. 어떤 방식을 사용할 수 있는가?
* 폴링 : 클라이언트가 지속적으로 서버에 연결을 생성해 받아올 메시지가 있는지 확인한다
* 롱폴링 : 클라이언트와 서버가 연결을 생성하면 메시지를 받거나 타임아웃이 발생할 때까지 연결을 유지한다
* 웹 소켓 : 서버와 클라이언트가 지속적인 웹 소켓 연결을 생성하여 양방향 통신을 수행한다

> 각 방식의 특징은 무엇인가?
* 폴링 : 서버에 지속적으로 연결을 생성하고 해제하기 때문에, 폴링을 자주 수행할수록 비효율적이다. 메세지가 없으면 불필요하게 연결을 생성하게 된다.
* 롱폴링 : 메시지를 수신받을 서버와 메시지를 요청하는 클라이언트가 동일 서버에 접속하지 않을 수 있다. 메시지를 많이 받지 않는 클라이언트도 주기적으로 서버와 연결을 생성해야 한다.
* 웹소켓 : 양방향 통신이 가능하다. 그러나 소켓 연결을 지속적으로 유지하므로 연결 관리를 효율적으로 해야한다.

> 채팅 서버에 웹 소켓 프로토콜을 사용한다고 결정했다. 특정 채팅 서버에 부하가 몰리지 않도록 어떻게 관리할 수 있는가?
* 클라이언트에게 적합한 채팅 서버를 할당해줄 수 있는 별도 시스템 컴포넌트를 추가한다. 클라이언트의 위치와 서버의 수용 가능 용량을 기반으로 연결을 생성할 채팅 서버를 결정한다.
</details>


<br>

### 채팅 시스템에 사용자 접속 상태를 관리를 위한 별도 서버를 생성하였다. 사용자의 접속 상태를 어떻게 기록하고 관리할 수 있겠는가?

* 사용자가 온라인에서 오프라인 상태로 전환되는 일은 자주 발생할 것이다. 따라서 매번 즉각적으로 사용자 접속 상태를 변경하는 것은 비효율적일텐데, 더 효율적으로 처리할 수 있는 방법에는 무엇이 있는가?
* 특정 사용자의 접속 상태가 변경되면 이를 친구 관계에 있는 사용자들에게 전송해야 한다. 어떻게 전송할 수 있는가?

<details>
<summary><h4>해설</h4></summary>

> 채팅 시스템에 사용자 접속 상태를 관리를 위한 별도 서버를 생성하였다. 사용자의 접속 상태를 어떻게 기록하고 관리할 수 있겠는가?
* 사용자가 채팅 시스템에 접속하면 웹 소켓 연결이 생성될 것이다. 연결이 생성되는 시점에 접속 상태 서버에 로그인 시각을 기록한다
* 사용자가 로그아웃 API를 호출하거나 웹 소켓 연결이 끊어지면 사용자의 접속 상태를 `offline`으로 기록한다

> 사용자가 온라인에서 오프라인 상태로 전환되는 일은 자주 발생할 것이다. 따라서 매번 즉각적으로 사용자 접속 상태를 변경하는 것은 비효율적일텐데, 더 효율적으로 처리할 수 있는 방법에는 무엇이 있는가?
* 온라인 상태의 클라이언트가 접속 상태를 관리하는 서버에 주기적으로 이벤트를 전송한다. 접속 상태 서버는 클라이언트로부터 일정 시간 이상 이벤트를 받지 못할 경우, 해당 클라이언트를 오프라인 상태로 변경한다.

> 특정 사용자의 접속 상태가 변경되면 이를 친구 관계에 있는 사용자들에게 전송해야 한다. 어떻게 전송할 수 있는가?
* 특정 사용자와 각각의 친구들 사이에 채널을 생성하고, 친구들을 채널을 구독한다. 사용자 접속 상태가 바뀌면 이를 채널에 이벤트로 발행하고, 각 친구들은 이벤트를 수신해 접속 상태 변경을 감지할 수 있다.
</details>
