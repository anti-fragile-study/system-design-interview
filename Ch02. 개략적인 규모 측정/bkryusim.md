# Ch02. 개략적인 규모 측정

### 질문

> 일관성, 가용성, 파티션 허용성(partition tolerance)에 대해 설명해 주세요.

* CAP를 동시에 만족시킬 수 없음을 증명해 주세요.
* 두 대의 DB 서버가 클러스터를 이루고 있습니다. 이 때 두 서버 사이의 네트워크가 단절되었을 때, 가용성과 일관성을 동시에 만족시킬 수 없는 이유를 말해 주세요.


<details>
<summary><h4>해설</h4></summary>

> 일관성, 가용성, 파티션 허용성(partition tolerance)에 대해 설명해 주세요.
* 일관성은 모든 노드가 같은 시점에 같은 데이터를 응답하는 성질입니다.
* 가용성은 모든 노드가 항상 동작하는 성질입니다.
* 파티션 허용성은 노드들 간 네트워크 단절이 발생해도 시스템이 정상적으로 동작하는 성질입니다.

> CAP를 동시에 만족시킬 수 없음을 증명해 주세요.
* 파티션 허용성을 만족시키는 경우, 일관성과 가용성 사이에 trade-off가 발생합니다. 아래 답변에서 더 설명합니다.

> 두 대의 DB 서버가 클러스터를 이루고 있습니다. 이 때 두 서버 사이의 네트워크가 단절되었을 때, 가용성과 일관성을 동시에 만족시킬 수 없는 이유를 말해 주세요.
* 쓰기 요청에 대해 가용성을 선택하는 경우, 쓰기 요청을 받은 노드가 쓰기 요청을 수행하면 두 노드의 데이터가 달라져 일관성이 깨집니다.
* 일관성을 선택하여 요청을 거절한 경우, 가용성이 깨지게 됩니다.
* 따라서 일관성과 가용성을 동시에 만족시키는 것은 불가능합니다.

</details>
<br>

### 질문
> DB 서버에 RAM 용량이 중요한 이유를 설명해 주세요.

* MySQL 8.0에서 쿼리 캐시가 삭제되었는데, 이유를 알고 있다면 설명해 주세요.
* SQL에서 바인드 변수를 사용하는 경우, 하지 않는 경우 어떤 차이가 있는지 설명해 주세요.

<details>
<summary><h4>해설</h4></summary>

> DB 서버에 RAM 용량이 중요한 이유를 설명해 주세요.
* 리눅스는 디스크에서 읽어 온 데이터를 남은 메모리 공간에 캐싱하는 정책을 갖고 있습니다. RAM 용량이 작으면 디스크 접근이 많아지고, 성능에 영향을 미치게 됩니다.

> MySQL 8.0에서 쿼리 캐시가 삭제되었는데, 이유를 알고 있다면 설명해 주세요.
* 쿼리 캐시는 조회가 쓰기에 비해 압도적으로 많은 특수한 상황에만 성능 이점이 있습니다. 그렇지 않은 경우 쓰기 요청마다 캐시를 초기화해야 하기 때문에 오히려 오버헤드가 발생해 성능 하락의 원인이 될 수 있습니다.

> SQL에서 바인드 변수를 사용하는 경우, 하지 않는 경우 어떤 차이가 있는지 설명해 주세요.
* 쿼리 파싱 시 만약 이전에 수행한 쿼리라면 이전의 실행계획을 그대로 가져와 하드 파싱을 수행하지 않습니다. 이 때 쿼리 캐싱을 위해 쿼리의 해시를 키로 캐싱하게 되는데, 바인드 변수를 사용하면 변수의 값이 바뀌어도 같은 실행 계획을 사용하므로 성능상 이점을 볼 수 있습니다.
</details>
<br>

### 질문

> 매일 10만명의 사용자가 이용하는 채팅 서비스가 있습니다. 한 사람당 하루 평균 20개정도의 메시지를 평균 10명의 상대에게 각각 보낸다는 통계 결과가 있습니다. QPS를 계산해 봅시다.

* 피크 타임의 QPS를 계산해 봅시다.
* 데이터가 계속 많아지면 어떤 문제가 발생할까요? 어떻게 해결할 수 있을까요?

<details>
<summary><h4>해설</h4></summary>

> 매일 10만명의 사용자가 이용하는 채팅 서비스가 있습니다. 한 사람당 하루 평균 20개정도의 메시지를 평균 10명의 상대에게 각각 보낸다는 통계 결과가 있습니다. QPS를 계산해 봅시다.
* 10만명이 하루 200건 메시지. 메시지에 대한 조회도 똑같은 횟수라고 가정하면 하루 4000만건의 쿼리.
* 4000만 / 24 / 3600 = 평균 약 463 qps

> 피크 타임의 QPS를 계산해 봅시다.
- 하루의 피크타임 3시간에 하루 트래픽의 80%가 몰린다고 가정하겠습니다.
- 4000만 * 0.8 / 3 / 3600 = 약 2963 QPS

> 데이터가 계속 많아지면 어떤 문제가 발생할까요? 어떻게 해결할 수 있을까요?
* RDBMS를 사용한다면 메시지를 저장하는 테이블의 인덱스가 너무 거대해져서 탐색 성능에 문제가 발생할 수 있을 것 같습니다. key-value형태로 저장할 수 있는 방법을 고안하거나, 샤딩 혹은 파티셔닝을 사용하여 수평 분할을 시도할 수 있을 것 같습니다.
</details>
<br>
