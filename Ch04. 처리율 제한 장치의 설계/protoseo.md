# Ch04. 처리율 제한 장치의 설계

> 처리율 제한 장치가 무엇이고 이를 사용하는 목적이 무엇인가요?

* 처리율 제한 장치 알고리즘 중 토큰 버킷 알고리즘이 어떻게 동작하는지 알고 계신가요? 알고 계시다면 설명해주세요.
* 그렇다면 토큰 버킷 알고리즘의 장단점은 무엇인가요?

<details>
<summary><h4>해설</h4></summary>

> 처리율 제한 장치가 무엇이고 이를 사용하는 목적이 무엇인가요? 
* 처리율 제한 장치는 클라이언트 또는 서비스에서 보내는 트래픽의 처리율을 제어하기 위한 장치이다. 이를 통해서 서버가 다운되는 등의 사고를 미연에 방지하므로 서비스의 안정성 및 성능을 보장할 수 있다. 그리고 과도한 트래픽으로부터 서비스를 보호할 수 있다.

> 처리율 제한 장치 알고리즘 중 토큰 버킷 알고리즘이 어떻게 동작하는지 알고 계신가요? 알고 계시다면 설명해주세요.
* 토큰 버킷 알고리즘은, 토큰 버킷이라는 지정된 양의 토큰을 저장하는 컨테이너에 주기적으로 사전에 설정된 양만큼 토큰이 주기적으로 채워진다. 각 요청은 처리될 때 마다 하나의 토큰을 사용하고, 요청이 도착했을때 버킷에 충분한 토큰이 있는지 검사하고 토큰이 있다면 토큰을 하나 꺼낸 후 요청을 전달하고, 토큰이 없다면 해당 요청이 버려진다.

> 그렇다면 토큰 버킷 알고리즘의 장단점은 무엇인가요?
* 장점으로는 구현이 쉽고, 메모리 사용 측면에서 효율적이다. 그리고 짧은 시간에 집중되는 트래픽도 처리 가능하다. 단점으로는 버킷의 크기와 토큰 공급률이라는 두 개의 인자를 가지고 있는데, 이 값을 적절하게 튜닝하는 것은 까다롭다.

</details>

<br>

> 분산 환경에 처리율 제한 장치를 도입하려고 할 때 고려해야 할 문제가 있을까요?

* 경쟁 조건이 발생하는 경우의 예시를 들어줄 수 있나요? 경쟁 조건을 해결하기 위해서는 어떤 방법이 있을까요?
* 동기화 문제는 어떤 방법을 통해서 해결할 수 있을까요?

<details>
<summary><h4>해설</h4></summary>

> 분산 환경에 처리율 제한 장치를 도입하려고 할 때 고려해야 할 문제가 있을까요?
* 경쟁 조건(race condition)과 동기화(synchronized)문제를 해결해야 한다.

> 경쟁 조건이 발생하는 경우의 예시를 들어줄 수 있나요? 그리고 이를 해결하려면 어떤 방법이 있을까요?
* 레디스를 활용해서 사용자의 요청을 추적하는 카운터를 둔다고 했을 때, 동시에 요청이 들어온 경우 레디스에서 한 요청이 카운터의 값을 읽고, 이 카운터의 값을 올리기 전에, 다른 요청이 이 카운터의 값을 읽는다면 증가하기 전의 카운터의 값을 읽으므로 카운터의 값이 총 2개가 증가해야 하지만, 1개만 증가하는 상황이 발생할 수 있다.
* 경쟁 조건 문제를 해결하기 위해서는 락을 사용할 수 있다. 락은 성능 문제가 있기 때문에, 다른 해결책으로는 루아 스크립트(lua script)나 레디스의 정렬 집합(sorted set)을 사용할 수 있다.

> 동기화 문제는 어떤 방법을 통해서 해결할 수 있을까요?
> 고정 세션을 활용하여 같은 클라이언트로부터의 요청은 항상 같은 처리율 제한 장치로 보내는 방법이 있지만, 이는 확장 가능하지 않고 유연하지 않아서 추천되지 않는다. 다른 방법으로는 레디스를 활용해서 중앙 집중형 데이터 저장소를 사용하는 방법이 있다.

</details>
