# Ch01. 근접성 서비스

> 현재 위치 주변에 있는 편의점을 찾는 서비스를 만들고 있습니다. 지금 구현은 주변 편의점을 찾기 위한 방법으로 현재 위치 반경에 위치한 편의점들을 SQL을 활용하고 있습니다. 이 구현 방법에서 발생할 수 있는 문제는 무엇이고 어떻게 해결할 수 있을까요?

* 2차원 지리적 정보에 인덱스를 만드는 방법은 다양한데, 그 방법들 중 지오해시 방법에 대해서 알려주세요.
* 지오해시 방법을 사용할 때 발생할 수 있는 문제점과 해결책에 대해서 알려주세요.

<details>
<summary><h4>해설</h4></summary>

> 현재 위치 주변에 있는 편의점을 찾는 서비스를 만들고 있습니다. 지금 구현은 주변 편의점을 찾기 위한 방법으로 현재 위치 반경에 위치한 편의점들을 SQL을 활용하고 있습니다. 이 구현 방법에서 발생할 수 있는 문제는 무엇이고 어떻게 해결할 수 있을까요?

* 테이블 전체를 읽어야 하는 상황이 발생할 수 있다. 또한, 위치라는 데이터는 2차원적이므로, 위도와 경도 컬럼에 각각 인덱스를 걸어도 이 두 집합의 교집합을 구해야 하기 때문에 비효율적이다.

> 2차원 지리적 정보에 인덱스를 만드는 방법은 다양한데, 그 방법들 중 지오해시 방법에 대해서 알려주세요.

* 지오해시는 2차원 위도 경도 데이터를 1차원의 문자열로 변환하는 방법이다. 전 세계를 자오선과 적도 기준 사분면으로 나누고, 그 각각의 격자를 계속 사분면으로 나눈다.  이 절차를 원하는 정밀도를 얻을 때 까지 반복하여 비트를 만들고 base32 표현법으로 변환하여 문자열을 얻는다.

> 지오해시 방법을 사용할 때 발생할 수 있는 문제점과 해결책에 대해서 알려주세요.

* 격자의 가장자리에서 문제가 발생할 수 있다. 지오해시는 해시값의 공통 접두어가 긴 격자들이 서로 더 가깝게 놓이도록 보장한다. 하지만 그 역은 참이 아니므로, 아주 가까운 두 위치가 어떤 공통 접두어를 갖지 않을 수 있다. 또 다른 문제점은 두 지점이 공통 접두어 길이는 길지만 서로 다른 격자에 놓일 수 있다.
  * 이는 현재 격자를 비롯한 인접한 모든 격자의 모든 사업장 정보를 가져와서 해결할 수 있다. 특정 지오해시의 주변 지오해시를 찾는 것은 상수 시간에 가능한 연산이다.

</details>
<br>

> 지리적 정보에 색인을 만드는 방법으로 쿼드트리 방법을 사용할 수 있는데, 쿼드트리에 관해서 설명해주세요.

* 쿼드트리를 활용해서 주변 사업장을 검색하는 과정에 대해서 설명해주세요. 
  * 사업장을 검색할 때, 주변 50개의 사업장이 반환되어야 한다고 가정하겠습니다. 
  * 쿼드트리의 각 노드는 50개의 사업장 ID를 저장하고 있습니다.
* 쿼드트리는 주로 서버가 올라갈 떄 구축됩니다. 이 경우에, 중간에 사업장 정보가 추가/삭제되는 경우 쿼드트리를 어떻게 갱신할 수 있을까요?

<details>
<summary><h4>해설</h4></summary>

> 지리적 정보에 색인을 만드는 방법으로 쿼드트리 방법을 사용할 수 있는데, 쿼드트리에 관해서 설명해주세요.

* 쿼드트리는 격자의 내용이 특정 기준을 만족할 때까지 2차원 공간을 재귀적으로 사분면 분할하는데 사용되는 자료 구조다. 예를 들어 격자에 담긴 사업장 수가 100 이하가 될 때까지 분할하는 것이다.
* 쿼드트리를 사용한다는 것은 질의에 답하는 데 사용될 트리 구조를 메모리 안에 만드는 것이다. 쿼드트리는 메모리 안에 놓이는 자료구조일 뿐 데이터베이스가 아니라는 것에 유의해야한다.

> 쿼드트리를 활용해서 주변 사업장을 검색하는 과정에 대해서 설명해주세요. 
> - 사업장을 검색할 때, 주변 50개의 사업장이 반환되어야 한다고 가정하겠습니다.
> - 쿼드트리의 각 노드는 50개의 사업장 ID를 저장하고 있습니다.

* 먼저 메모리에 쿼드트리 인덱스를 구축한다.
* 검색 시작점이 포함된 말단 노드를 만날 때 까지, 트리의 루트 노드부터 탐색한다. 
* 해당 노드에 50개 사업장이 있는 경우 해당 노드만 반환하고, 그렇지 않다면 충분한 사업장 수가 확보될 때 까지 인근 노드를 추가한다.

> 쿼드트리는 주로 서버가 올라갈 떄 구축됩니다. 이 때, 중간에 사업장 정보가 추가/삭제되는 경우 쿼드트리를 어떻게 갱신할 수 있을까요?

* 가장 쉬운 방법으로는 점진적으로 몇 개씩만 갱신하는 것이다. 하지만 짧은 시간이지만 낡은 데이터가 반환될 수 있다. 요구사항이 엄격하지만 않다면 충분히 용인될 수 있다.
  * 운영적으로 새로 추가하거나 갱신한 사업장 정보는 다음날 반영된다는 식의 협약을 맺어 놓으면 위의 문제는 사소한 문제가 될 수 있다.
  * 하지만 수 많은 키가 한번에 무효화되어 캐시 서버에 막대한 부하가 가해질 수 있다.
* 쿼드트리를 실시간으로 갱신하는 것도 가능하지만, 설계가 복잡해질 수 있다. 여러 스레드가 쿼드트리에 동시 접근하는 경우가 발생할 수 있기 때문에 락을 활용해서 해결해야한다.

</details>
